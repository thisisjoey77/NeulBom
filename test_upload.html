<!DOCTYPE html>
<html>
<head>
    <title>Frame Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        video, canvas { border: 1px solid #ccc; margin: 10px 0; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; }
        #results { margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Frame Upload Test</h1>
        
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        
        <div>
            <button onclick="startCamera()">Start Camera</button>
            <button onclick="captureFrame()">Capture & Upload Frame</button>
        </div>
        
        <div id="results">
            <div id="status">Status: Ready</div>
            <div id="response">Response: None</div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const response = document.getElementById('response');
        
        // Backend URL - change this to your server URL
        const BACKEND_URL = 'http://54.180.16.112:5000/process_frame';
        
        async function startCamera() {
            try {
                status.textContent = 'Status: Starting camera...';
                status.className = '';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                
                status.textContent = 'Status: Camera started';
                status.className = 'success';
            } catch (err) {
                status.textContent = `Status: Camera error - ${err.message}`;
                status.className = 'error';
                console.error('Camera error:', err);
            }
        }
        
        async function captureFrame() {
            if (video.readyState !== 4) {
                status.textContent = 'Status: Video not ready';
                status.className = 'error';
                return;
            }
            
            try {
                status.textContent = 'Status: Capturing frame...';
                status.className = '';
                
                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to data URL and then to blob
                const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                
                const blob = await fetch(dataURL).then(res => res.blob());
                
                if (!blob || blob.size === 0) {
                    throw new Error('Failed to create blob from canvas');
                }
                
                status.textContent = `Status: Uploading frame (${blob.size} bytes)...`;
                console.log(`Uploading frame: ${blob.size} bytes`);
                
                // Upload to server
                const formData = new FormData();
                formData.append('frame', blob, 'frame.jpg');
                
                const uploadResponse = await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await uploadResponse.json();
                
                if (uploadResponse.ok) {
                    status.textContent = 'Status: Upload successful!';
                    status.className = 'success';
                    response.textContent = `Response: ${JSON.stringify(data)}`;
                    response.className = 'success';
                } else {
                    status.textContent = `Status: Upload failed (${uploadResponse.status})`;
                    status.className = 'error';
                    response.textContent = `Response: ${JSON.stringify(data)}`;
                    response.className = 'error';
                }
                
            } catch (err) {
                status.textContent = `Status: Error - ${err.message}`;
                status.className = 'error';
                response.textContent = `Response: Error - ${err.message}`;
                response.className = 'error';
                console.error('Capture error:', err);
            }
        }
    </script>
</body>
</html>
